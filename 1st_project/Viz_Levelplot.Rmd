---
title: "Viz_Levelplot"
author: "Arndt Allhorn"
date: "May 14, 2018"
output: html_document
runtime: shiny
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r heatmap, echo=FALSE}
library(ggplot2,quietly=TRUE)

setwd("~/git-reps/visualization/1st_project/")

measures <- read.csv2("LabMeasurements-Color-Card.csv")
master <- read.csv2("MasterColorCard.csv")

# RESHAPE DATA (pivot measures)
data = data.frame("row"=c(),"col"=c(),"L"=c(),"a"=c(),"b"=c(), "L.master"=c(),"a.master"=c(),"b.master"=c())
for(row in 1:8){
  for(col in 1:8){
    # get master-colour
    index = which(master$Crow==row & master$Ccol==col)
    data_master = master[index,c("L","a","b")]
    
    # reshape measures-dataframe and calculate difference to master-colour
    data = rbind(data,
                 rbind(
                   cbind(row,
                         col,
                         measures[[paste("L",row,col,sep="",collapse="")]],
                         measures[[paste("a",row,col,sep="",collapse="")]],
                         measures[[paste("b",row,col,sep="",collapse="")]],
                         data_master$L, 
                         data_master$a, 
                         data_master$b
                  )
                 )
                )
  }
}
colnames(data) = c("row","col","L","a","b","L.master","a.master","b.master")
data$deltaE = sqrt((data$L-data$L.master)^2 + (data$a-data$a.master)^2 + (data$b-data$b.master)^2)

# Add positioning dimensions

posdim = matrix(0,34944,3) #initialize empty
i = 1
for (pos in 1:64){
  for (target.col in 1:6){
    for (target.row in 1:7){
      for (sheet.no in 1:13){
        posdim[i,1]<-sheet.no
        posdim[i,2]<-target.row
        posdim[i,3]<-target.col
        i=i+1
      }
    }
  }
}
posdim = data.frame(posdim)
colnames(posdim) = c("sheet.no","target.row","target.col")
data = cbind(posdim,data)

# Plot the data

index = which(data$sheet.no==1 & data$target.row==1 & data$target.col==1)
ggdata1 <-data[index,c("target.row","target.col","row","col","deltaE")]
ggplot(ggdata1, aes(col, row, z= deltaE)) + geom_tile(aes(fill = deltaE)) + 
  theme_bw() +
  scale_fill_gradientn(colours=heat.colors(100)[length(heat.colors(100)):1], values=c(0,0.01,0.02,0.1,0.49,1)) # Delta E classes

```

## Including Plots

You can also embed plots, for example:

```{r heatmap facetting, echo=FALSE, fig.height=10, fig.width=10}
# Arrange multiple plots via Facetting

ggdata <- data[which(data$sheet.no==1),c("target.row","target.col","row","col","deltaE")] #sheet no fixed here
ggplot(ggdata, aes(col, row, z=deltaE)) + geom_tile(aes(fill=deltaE)) + 
  theme_bw() +
  facet_grid(target.row ~ target.col) +
  scale_fill_gradientn(colours = heat.colors(100)[length(heat.colors(100)):1], values=c(0,0.01,0.02,0.1,0.49,1)) + # Delta E classes
  labs(title="Sheet #???", x="", y="")

```

See e plot:

```{r heatmaps facetting, echo=F}
require(ggplot2)
shinyApp(
  ui = fluidPage(
    selectInput("sheet.no", label="Sheet number", choices=1:13, selected=1, multiple=F),
    plotOutput("heatmap")
    #htmlOutput("heatmap")
  ),
  server = function(input, output) {
    output$heatmap <- renderPlot({
      ggdata <- data[which(data$sheet.no==input$sheet.no),
                     c("target.row","target.col","row","col","deltaE")]
      ggplot(ggdata, aes(col, row, z=deltaE)) + 
        geom_tile(aes(fill=deltaE)) + 
        theme_bw() +
        facet_grid(target.row ~ target.col) +
        scale_fill_gradientn(colours = heat.colors(100)[length(heat.colors(100)):1], 
                             values=c(0,0.01,0.02,0.1,0.49,1)) + # values of Delta E classes
        labs(title=paste("Sheet #",input$sheet.no,sep="",collapse=""), x="", y="")
    }, height=900, width=900)
  },
  options = list(height=1500)
)
```


